<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chofer · Envío de ubicación</title>
  <style>
    :root{
      --bg:#f4f5f7; --card:#fff; --text:#111827; --muted:#6b7280; --border:#e5e7eb;
      --btn:#111827;
    }
    body{margin:0;font-family:Arial,sans-serif;background:var(--bg);color:var(--text);}
    .wrap{max-width:980px;margin:0 auto;padding:14px;}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;}
    h1{margin:0 0 6px 0;font-size:22px;}
    p{margin:0 0 12px 0;color:var(--muted);font-size:14px;}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px;}
    input{
      width:100%;box-sizing:border-box;padding:12px;border-radius:10px;border:1px solid var(--border);
      font-size:14px;
    }
    .row{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px;}
    .btn{
      flex:1;
      background:var(--btn);
      color:#fff;border:0;border-radius:12px;padding:12px 14px;font-size:14px;font-weight:700;
      cursor:pointer;
    }
    .btn.secondary{background:#fff;color:#111827;border:1px solid var(--border);font-weight:700;}
    .btn.danger{background:#fff;color:#b91c1c;border:1px solid #fecaca;}
    .statusline{margin-top:12px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .pill{font-size:12px;padding:6px 10px;border-radius:999px;background:#f3f4f6;border:1px solid var(--border);color:#374151;}
    #status{font-size:13px;color:#374151;}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Envío de ubicación (Chofer)</h1>
      <p>Dejá esta pantalla abierta durante el traslado.</p>

      <label>Token del servicio</label>
      <input id="token" value="%%TOKEN%%" />

      <div class="row">
        <button class="btn" id="start">Iniciar envío</button>
        <button class="btn secondary" id="stop">Detener envío</button>
      </div>

      <div class="row">
        <button class="btn danger" id="finish">Finalizar servicio</button>
      </div>

      <div class="statusline">
        <span id="status">Estado: listo</span>
        <span class="pill mono" id="pill">—</span>
      </div>
    </div>
  </div>

<script>
  // SIEMPRE el backend es el mismo origen donde abriste /driver/...
  // (esto evita 127.0.0.1 vs Render y evita placeholders)
  const backend = window.location.origin;

  let watchId = null;

  const statusEl = document.getElementById("status");
  const pillEl = document.getElementById("pill");

  function setPill(txt){ pillEl.textContent = txt; }

  async function postJSON(url, payload){
    return fetch(url, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(payload)
    });
  }

  async function enviarUnaVez(){
    const token = document.getElementById("token").value.trim();
    if(!token){ statusEl.textContent = "Estado: faltó token"; return; }

    if(!navigator.geolocation){
      statusEl.textContent = "Estado: este dispositivo no soporta GPS";
      return;
    }

    statusEl.textContent = "Estado: pidiendo permiso de ubicación…";

    navigator.geolocation.getCurrentPosition(async (pos) => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;

      try{
        statusEl.textContent = "Estado: enviando ubicación…";
        const res = await postJSON(`${backend}/update/${encodeURIComponent(token)}`, {lat, lon});
        if(!res.ok){
          statusEl.textContent = `Estado: error enviando (${res.status})`;
          setPill("Revisar backend");
          return;
        }
        statusEl.textContent = "Estado: enviando (OK)";
        setPill(`lat=${lat.toFixed(6)} lon=${lon.toFixed(6)}`);
      }catch(e){
        statusEl.textContent = "Estado: error enviando";
        setPill("Sin conexión");
        console.log(e);
      }
    }, (err) => {
      statusEl.textContent = "Estado: no se pudo obtener ubicación";
      setPill(err.message || "Error GPS");
    }, { enableHighAccuracy:true, maximumAge:2000, timeout:10000 });
  }

  document.getElementById("start").onclick = async () => {
    const token = document.getElementById("token").value.trim();
    if(!token){ statusEl.textContent = "Estado: faltó token"; return; }
    if(!navigator.geolocation){
      statusEl.textContent = "Estado: este dispositivo no soporta GPS";
      return;
    }

    // primero envío una vez
    await enviarUnaVez();

    // después arranco seguimiento continuo
    if(watchId !== null) navigator.geolocation.clearWatch(watchId);

    statusEl.textContent = "Estado: en curso";
    watchId = navigator.geolocation.watchPosition(async (pos) => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      try{
        const res = await postJSON(`${backend}/update/${encodeURIComponent(token)}`, {lat, lon});
        if(!res.ok){
          statusEl.textContent = `Estado: error enviando (${res.status})`;
          return;
        }
        setPill(`lat=${lat.toFixed(6)} lon=${lon.toFixed(6)}`);
      }catch(e){
        statusEl.textContent = "Estado: sin conexión";
      }
    }, (err) => {
      statusEl.textContent = "Estado: error GPS";
      setPill(err.message || "Error GPS");
    }, { enableHighAccuracy:true, maximumAge:2000, timeout:10000 });
  };

  document.getElementById("stop").onclick = () => {
    if(watchId !== null){
      navigator.geolocation.clearWatch(watchId);
      watchId = null;
    }
    statusEl.textContent = "Estado: detenido";
    setPill("—");
  };

  document.getElementById("finish").onclick = async () => {
    const token = document.getElementById("token").value.trim();
    if(!token){ statusEl.textContent = "Estado: faltó token"; return; }

    // paro envío
    if(watchId !== null){
      navigator.geolocation.clearWatch(watchId);
      watchId = null;
    }

    try{
      const res = await postJSON(`${backend}/finish/${encodeURIComponent(token)}`, {});
      if(!res.ok){
        statusEl.textContent = `Estado: no se pudo finalizar (${res.status})`;
        return;
      }
      statusEl.textContent = "Estado: servicio finalizado";
      setPill("OK");
    }catch(e){
      statusEl.textContent = "Estado: error finalizando";
    }
  };
</script>
</body>
</html>

