# -*- coding: utf-8 -*-
"""main.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/147woLot8yAah0Z-6lqqwCtnn3wgc8yMW
"""

from time import time
from fastapi import FastAPI, HTTPException
from fastapi.staticfiles import StaticFiles
from fastapi.responses import HTMLResponse
from pydantic import BaseModel

app = FastAPI()

# Servir archivos estáticos (logo y HTML si querés)
app.mount("/static", StaticFiles(directory="static"), name="static")

def load_html(path: str) -> str:
    with open(path, encoding="utf-8") as f:
        return f.read()

# ===== PÁGINAS PARA FAMILIA / CHOFER (con token en la URL) =====
@app.get("/seguir/{token}", response_class=HTMLResponse)
def seguir_token(token: str):
    html = load_html("static/tracking.html")
    return html.replace("%%TOKEN%%", token)

@app.get("/driver/{token}", response_class=HTMLResponse)
def driver_token(token: str):
    html = load_html("static/driver.html")
    return html.replace("%%TOKEN%%", token)

# ===== API GPS =====
class Location(BaseModel):
    lat: float
    lon: float
    ts: float | None = None

store = {}

@app.post("/update/{token}")
def update_location(token: str, loc: Location):
    store[token] = {"lat": loc.lat, "lon": loc.lon, "ts": loc.ts or time()}
    return {"ok": True}

@app.get("/last/{token}")
def last_location(token: str):
    if token not in store:
        raise HTTPException(status_code=404, detail="No data yet")
    return store[token]

